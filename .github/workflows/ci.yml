name: CI/CD Pipeline

on:
  push:
    branches:
      - main  # Trigger workflow on push to main branch
  pull_request:
    branches:
      - main  # Trigger workflow on pull requests targeting main branch
  workflow_dispatch:  # Allow manual triggering of the workflow

env:
  # Environment variables for secrets and sensitive data
  DEV_ENV: development
  STAGING_ENV: staging
  PROD_ENV: production
  DOCKER_REGISTRY: ${DOCKER_REGISTRY}  # Docker registry URL
  DOCKER_USERNAME: ${DOCKER_USERNAME}  # Docker registry username
  DOCKER_PASSWORD: ${DOCKER_PASSWORD}  # Docker registry password
  PYPI_TOKEN: ${PYPI_TOKEN}  # PyPI token for publishing Python packages

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'  # Specify Python version

      - name: Install Linter
        run: |
          python -m pip install --upgrade pip
          pip install flake8  # Install Python linter

      - name: Run Python Linter
        run: flake8 . --max-line-length=88  # Lint Python code

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'  # Specify Node.js version

      - name: Install JavaScript Linter
        run: npm install eslint --global  # Install JavaScript linter

      - name: Run JavaScript Linter
        run: eslint .  # Lint JavaScript code

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10']  # Test against multiple Python versions
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt  # Install Python dependencies

      - name: Run Unit Tests
        run: pytest --maxfail=5 --disable-warnings  # Run Python unit tests

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Install JavaScript Dependencies
        run: npm install  # Install JavaScript dependencies

      - name: Run JavaScript Tests
        run: npm test  # Run JavaScript tests

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Log in to Docker Registry
        run: echo "${DOCKER_PASSWORD}" | docker login ${DOCKER_REGISTRY} -u "${DOCKER_USERNAME}" --password-stdin

      - name: Build Docker Image
        run: docker build -t ${DOCKER_REGISTRY}/federated-learning-framework:${{ github.sha }} .

      - name: Push Docker Image
        run: docker push ${DOCKER_REGISTRY}/federated-learning-framework:${{ github.sha }}

  deploy:
    name: Deploy to Environment
    runs-on: ubuntu-latest
    needs: [lint, test, build]  # Ensure linting, testing, and building are successful
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Deploy to Staging
        if: github.ref == 'refs/heads/main' && env.STAGING_ENV == 'staging'
        run: |
          echo "Deploying to staging environment..."
          # Add deployment commands for staging here

      - name: Deploy to Production
        if: github.ref == 'refs/heads/main' && env.PROD_ENV == 'production'
        run: |
          echo "Deploying to production environment..."
          # Add deployment commands for production here